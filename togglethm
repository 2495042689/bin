#! /bin/sh

PATH="/usr/local/bin:${PATH}"
BGTYPE="$HOME"/.bgtype

curbg=$(cat "$BGTYPE")

if [ $# -gt 0 ] ; then
	nextbg=$1
else
	case "$curbg" in
		light)
			nextbg=dark
			;;
		dark)
			nextbg=light
			;;
	esac
fi

printf "%s" "$nextbg" > "$BGTYPE"

if [ "$nextbg" != "$curbg" ] ; then
	echo ":colorscheme bubblegum-256-${nextbg}" | tmux load-buffer -
	for sess in $(tmux list-sessions -F "#{session_id}") ; do
		for win in $(tmux list-windows -t "$sess" -F "#{window_id}") ; do
			for pane_pid in $(tmux list-panes -t "$win" -F "#{pane_id},#{pane_pid}") ; do
				pane=${pane_pid%,*}
				pid=${pane_pid#*,}
				while [ -n "$pid" ] ; do
					if ps -p $pid -o comm= | grep "^vim$" > /dev/null ; then
						tmux paste-buffer -t "$pane"
						pid=""
					else
						pid=$(pgrep -P $pid -n)
					fi
				done
			done
		done
	done
	tmux delete-buffer
fi
