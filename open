#! /bin/dash
#
# open -- file / url opener
#
#

while [ $# -gt 0 ] ; do
    if [ -d "$1" ]; then
        ncd "$1"
    elif [ -e "$1" ]; then
        mime_type=$(file -L -b --mime-type "$1")
        # the order is important, e.g. foo/bar must appear before foo/*
        DATA_FILE="$XDG_DATA_HOME/open.data"
        fp=$(readlink -f "$1")
        Z -i "$DATA_FILE" -a "$fp"
        case $mime_type in
            inode/x-empty)
                editor "$fp"
                ;;
            video/*|application/vnd.rn-realmedia)
                video_player "$fp"
                ;;
            audio/*)
                audio_player "$fp"
                ;;
            image/vnd.djvu)
                document_reader "$fp"
                ;;
            image/x-canon-cr2)
                dcraw -T -w "$fp"
                ;;
            image/svg+xml|application/x-shockwave-flash)
                web_browser "$fp"
                ;;
            image/x-xcf)
                gimp "$fp"
                ;;
            image/*)
                image_viewer "$fp"
                ;;
            application/x-lha)
                lha x "$fp"
                ;;
            application/postscript)
                document_reader "$fp"
                ;;
            application/pdf)
                document_reader "$fp"
                ;;
            application/zip)
                unzip -d "${@%.*}" "$fp"
                ;;
            application/x-tar)
                tar xvf "$fp"
                ;;
            application/x-rar)
                unrar -ad x "$fp"
                ;;
            application/x-bittorrent)
                diana_add "$fp"
                ;;
            application/vnd.ms-opentype|application/x-font-ttf|application/vnd.font-fontforge-sfd)
                fontforge "$fp"
                ;;
            text/html)
                web_browser "$fp"
                ;;
            text/troff)
                man -l "$fp"
                ;;
            *)
                case "$fp" in
                    *.tar.gz|*.tgz)
                        tar xvzf "$fp"
                        ;;
                    *.tar.xz)
                        tar xvJf "$fp"
                        ;;
                    *.tar.bz2)
                        tar xvjf "$fp"
                        ;;
                    *.bz2)
                        bunzip2 "$fp"
                        ;;
                    *.tar)
                        tar xvf "$fp"
                        ;;
                    *.gz)
                        gunzip "$fp"
                        ;;
                    *.ace)
                        unace x "$fp"
                        ;;
                    *.7z)
                        7z x "$fp"
                        ;;
                    *.chm)
                        xchm "$fp"
                        ;;
                    *.nzb)
                        nzbget -A "$fp"
                        ;;
                    *.nfo)
                        editor "$fp"
                        ;;
                    *.pcf|*.bdf|*.pfb)
                        fontforge "$fp"
                        ;;
                    *.svg)
                        web_browser "$fp"
                        ;;
                    *.pps|*.PPS|*.ppt|*.PPT)
                        ppsei "$fp"
                        ;;
                    *.abw)
                        abiword "$fp"
                        ;;
                    *.rtf|*.doc)
                        catdoc -w -s cp1252 "$fp"
                        ;;
                    *.xls)
                        xls2csv -s cp1252 "$fp"
                        ;;
                    *.xpm)
                        image_viewer "$fp"
                        ;;
                    *.mp3|*.m3u|*.ogg)
                        audio_player "$fp"
                        ;;
                    *.mp4|*.avi|*.mpg|*.mpeg|*.mkv|*.ogv|*.f4v|*.m2ts)
                        video_player "$fp"
                        ;;
                    *.webarchive)
                        tmp_xml=$(mktemp)
                        tmp_html=$(mktemp)
                        plutil -i "$fp" -o "$tmp_xml"
                        webarchive_decodemain "$tmp_xml" > "$tmp_html"
                        web_browser "$tmp_html"
                        rm "$tmp_xml"
                        ;;
                    *.blend)
                        blender "$fp"
                        ;;
                    *.emulecollection)
                        amule-emc "$fp"
                        ;;
                    *)
                        mime_encoding=$(file -L -b --mime-encoding "$fp")
                        case $mime_encoding in
                            *binary)
                                xxd -l 128 "$fp"
                                ;;
                            *)
                                editor "$fp"
                                ;;
                        esac
                        ;;
                esac
                ;;
        esac
    else
        case "$1" in
            *://*)
                web_browser "$1"
                ;;
            *:*)
                handle_uri "$1"
                ;;
            *@*.*)
                mutt "$1"
                ;;
            *)
                echo "file not found: '$1'" >&2
                exit 1
                ;;
        esac
    fi
    shift
done
